uint16_t WantedTDS = 500;
const unsigned long DEBOUNCE_MS = 40UL;
const float TDS_HYSTERESIS = 50.0; 
//pHSensor
#define pHSensorPin A2

#include <Wire.h>
#include "RTClib.h"
RTC_DS3231 rtc;

// About screen timing
const unsigned long ABOUT_DURATION_MS = 5000UL;
unsigned long aboutStartMillis = 0;
bool aboutShowing = false;
bool aboutDisplayed = false;
bool drainRunning = false;
//IdleTimeout
  bool idleMode = false;
  unsigned long lastSignificantActivity = 0;   // update whenever K1/K2/K3/K4 pressed
  unsigned long idleStartTime = 0;
  const unsigned long IDLE_TO_GIF_MS = 15000UL;  // 15s of no activity → enter idle mode
  const unsigned long IDLE_SCREEN_DURATION = 10000UL; // idle screen shows for 10s
  // idle animation globals ---
  uint8_t idleGifFrameIndex = 0;            // which frame to show next
  unsigned long lastGifFrameTime = 0;       // last frame timestamp
  const unsigned long IDLE_GIF_FRAME_MS = 1000UL; // ms per frame (tweak this)

//MosfetControl
#define LEDPIN 4
#define WaterMotorPIN 11
#define PeristalticPumpSolutionPIN 10
#define PeristalticPumpDrainPIN 9


bool LEDState = false;
unsigned long LEDStartTime = 0;
const unsigned long LEDCycleOnDuration = 25000UL;
const unsigned long LEDCycleOffDuration = 15000UL;
bool ModeAuto = false;

//OLED I2C
  #include <SPI.h>
  #include <Adafruit_GFX.h>
  #include <Adafruit_SSD1306.h>
  #define SCREEN_WIDTH 128 
  #define SCREEN_HEIGHT 64
  Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// OLED I2C Button
  #define K1Pin 3 //Mode
  #define K2Pin 5 //Refresh
  #define K3Pin 6 //Drain
  //The Drain activation pin is 2005 ie button  k3,k3,k1,k2 in this oder in this exact sequence under 4s
  #define K4Pin 7 //about/info button
  uint8_t K1State = 0;
  uint8_t K2State = 0;
  uint8_t K3State = 0;
  uint8_t K4State = 0;



//DHTSensor
  #include <DHT.h>
  #define DHTPIN 2     // what pin we're connected to
  #define DHTTYPE DHT22   // DHT 22  (AM2302)
  DHT dht(DHTPIN, DHTTYPE); //// Initialize DHT sensor for normal 16mhz Arduino
  float hum;  //Stores humidity value
  float temp; //Stores temperature value
//TDS Sensor
  #define TdsSensorPin A0
  #define VREF 5.0              // analog reference voltage(Volt) of the ADC
  #define SCOUNT  8          // sum of sample point
  uint16_t analogBuffer[SCOUNT];     // store the analog value in the array, read from ADC
  uint16_t analogBufferTemp[SCOUNT];
  uint8_t analogBufferIndex = 0;
  uint8_t copyIndex = 0;
  float averageVoltage = 0;
  float tdsValue = 0;
  float temperature = 16;       
  // median filtering algorithm
  int getMedianNum(int bArray[], int iFilterLen){
  int bTab[iFilterLen];
  for (byte i = 0; i<iFilterLen; i++)
  bTab[i] = bArray[i];
  int i, j, bTemp;
  for (j = 0; j < iFilterLen - 1; j++) {
    for (i = 0; i < iFilterLen - j - 1; i++) {
      if (bTab[i] > bTab[i + 1]) {
        bTemp = bTab[i];
        bTab[i] = bTab[i + 1];
        bTab[i + 1] = bTemp;
      }
    }
  }
  if ((iFilterLen & 1) > 0){
    bTemp = bTab[(iFilterLen - 1) / 2];
  }
  else {
    bTemp = (bTab[iFilterLen / 2] + bTab[iFilterLen / 2 - 1]) / 2;
  }
  return bTemp;
  }

//Water Level Sensor
  #define WaterLevelSensorPin A1
  uint16_t waterlevel = 0;
  
// Sequence detection globals
  const unsigned long SEQ_TIMEOUT_MS = 10000UL;   

  const uint8_t SEQ_LEN = 4;
  const uint8_t requiredSequence[SEQ_LEN] = { K3Pin, K3Pin, K1Pin, K2Pin };

  uint8_t seqIndex = 0;
  unsigned long seqStartMillis = 0;

  // last stable states for edge detection (initialize to HIGH because using INPUT_PULLUP)
  uint8_t lastK1State = HIGH;
  uint8_t lastK2State = HIGH;
  uint8_t lastK3State = HIGH;
  uint8_t lastK4State = HIGH;


//CatGif
  const unsigned char CatGifCatGif1 [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x78, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x78, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x07, 0x80, 0x78, 0x00, 0x70, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x7c, 0xf8, 0x00, 0x00, 0x00, 0xfa, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x07, 0xff, 0xff, 0xff, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xe0, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfe, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfe, 0x00, 0x00, 
	0x00, 0x07, 0xc7, 0x80, 0x78, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 
	0x00, 0x07, 0xc7, 0x80, 0x78, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x7f, 0x80, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 
	0x00, 0x07, 0xc0, 0x7f, 0x80, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 
	0x00, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 
	0x00, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 
	0x00, 0x3f, 0xc0, 0x00, 0x07, 0x8f, 0x80, 0x00, 0xff, 0x00, 0x00, 0x1f, 0xff, 0xe1, 0xfc, 0x00, 
	0x00, 0x3f, 0xc0, 0x00, 0x07, 0x8f, 0x80, 0x00, 0xff, 0x00, 0x00, 0x1f, 0xff, 0xe1, 0xfc, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x01, 0xfc, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x01, 0xfc, 0x00, 
	0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x01, 0xfc, 0x00, 
	0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x01, 0xfc, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  };
  const unsigned char CatGifCatGif2 [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x78, 0x78, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x7f, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x7f, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xc0, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 
	0x00, 0x07, 0x87, 0x80, 0x78, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 0x00, 
	0x00, 0x07, 0x87, 0x80, 0x78, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0xff, 0x80, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 
	0x00, 0x07, 0x80, 0x7f, 0x80, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 
	0x00, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00, 
	0x00, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x7f, 0x80, 0x00, 0x0f, 0x8f, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x7f, 0x80, 0x00, 0x0f, 0x8f, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe3, 0xfc, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe3, 0xfc, 0x00, 
	0x00, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x03, 0xfc, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  };
  const uint8_t CatGifallArray_LEN = 2;
  const unsigned char* CatGifallArray[2] = {
	CatGifCatGif1,
	CatGifCatGif2
  };

void setup() {
Serial.begin(9600);
if (!rtc.begin()) {
    Serial.println("RTC not found");
    while (1);
  }

if (rtc.lostPower()) {
    Serial.println("RTC lost power, setting time");
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  }

Serial.println("The Keys to be pressed are K3, K3, K1, K2");
//IdleTimeout 
  lastSignificantActivity = millis();
//MosfetControl
  pinMode(LEDPIN, OUTPUT);
  digitalWrite(LEDPIN, LOW);
  LEDState = false;
  LEDStartTime = millis();       // timestamp of the last state change
  pinMode(WaterMotorPIN, OUTPUT);
  pinMode(PeristalticPumpSolutionPIN, OUTPUT);
  pinMode(PeristalticPumpDrainPIN, OUTPUT);
  digitalWrite(PeristalticPumpDrainPIN, LOW);
  digitalWrite(PeristalticPumpSolutionPIN, LOW);

//DHTSensor
  dht.begin();
//TDSSensor
  pinMode(TdsSensorPin,INPUT);

//OLED I2C
  pinMode(K1Pin, INPUT_PULLUP);
  pinMode(K2Pin, INPUT_PULLUP);
  pinMode(K3Pin, INPUT_PULLUP);
  pinMode(K4Pin, INPUT_PULLUP);

  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { // Address 0x3D for 128x64
    display.println(F("SSD1306 allocation failed"));
    for(;;);
  }
  delay(2000);
  display.clearDisplay();
  display.setTextSize(1); 
  display.setTextColor(WHITE);  
  display.setCursor(0,0);
  display.print(F("This shit be working!"));
  display.print(F("Hooray"));
  display.display(); 
	delay(2000);

 
//Water Level Sensor
  pinMode(WaterLevelSensorPin, INPUT); 
}
void loop() {
  DateTime now = rtc.now();

//WaterLevelSensor
  waterlevel = analogRead(WaterLevelSensorPin);
  uint8_t waterlevel_scaled = waterlevel / 10;
  if (drainRunning){
    if (waterlevel_scaled <= 20){
      drainRunning = false;
      digitalWrite(PeristalticPumpDrainPIN, LOW);
    }
    if (waterlevel_scaled > 20){
      Serial.print(F("Draining..."));
      digitalWrite(PeristalticPumpDrainPIN, HIGH);
      digitalWrite(WaterMotorPIN, LOW);
      digitalWrite(PeristalticPumpSolutionPIN,LOW);
      display.clearDisplay();
      display.setCursor(0, 0);
      display.print("Draining...");
      display.setCursor(0, 10);
      display.print(F("Water:"));
      display.print(waterlevel_scaled);
      display.print(F("/100 "));
      display.setCursor(0, 40);
      display.print(F("*Draining stops at water level <= 20/100."));
      display.display();
      delay(500);
    }
  }
//MainScreen  
//ModeSetup
  if (ModeAuto == false)digitalWrite(PeristalticPumpSolutionPIN, LOW);
  if (ModeAuto == true && drainRunning == false){
    if (tdsValue < WantedTDS - TDS_HYSTERESIS) {
    digitalWrite(PeristalticPumpSolutionPIN, HIGH);
  } else if (tdsValue > WantedTDS + TDS_HYSTERESIS) {
    digitalWrite(PeristalticPumpSolutionPIN, LOW);
  }
  }
 if (!idleMode && !aboutShowing && drainRunning == false){
  digitalWrite(WaterMotorPIN, HIGH);
 //DHTSensor
  hum = dht.readHumidity();
  temp= dht.readTemperature();
  temperature = temp;   // using ambient temperature for TDS compensation
 //TDS Sensor
  static unsigned long analogSampleTimepoint = millis();
  if(millis()-analogSampleTimepoint > 40U){     //every 40 milliseconds,read the analog value from the ADC
    analogSampleTimepoint = millis();
    analogBuffer[analogBufferIndex] = analogRead(TdsSensorPin);    //read the analog value and store into the buffer
    analogBufferIndex++;
    if(analogBufferIndex == SCOUNT){ 
      analogBufferIndex = 0;
    }
  }   
  static unsigned long printTimepoint = millis();
  if(millis()-printTimepoint > 1000U){
    printTimepoint = millis();
    for(copyIndex=0; copyIndex<SCOUNT; copyIndex++){
      analogBufferTemp[copyIndex] = analogBuffer[copyIndex];
      
      // read the analog value more stable by the median filtering algorithm, and convert to voltage value
      averageVoltage = getMedianNum(analogBufferTemp,SCOUNT) * (float)VREF / 1024.0;
      
      //temperature compensation formula: fFinalResult(25^C) = fFinalResult(current)/(1.0+0.02*(fTP-25.0)); 
      float compensationCoefficient = 1.0+0.02*(temperature-25.0);
      //temperature compensation
      float compensationVoltage=averageVoltage/compensationCoefficient;
      
      //convert voltage value to tds value
      tdsValue=(133.42*compensationVoltage*compensationVoltage*compensationVoltage - 255.86*compensationVoltage*compensationVoltage + 857.39*compensationVoltage)*0.5;
    }
  }
  //OLED I2C
 //TDS
  display.clearDisplay();
  display.setCursor(0,10);
  display.print(F("TDS Value:"));
  display.print(tdsValue,0);
  display.print(F("ppm"));

 //Water Level
  display.setCursor(0, 20);
  display.print(F("Water:"));
  display.print(waterlevel_scaled,1);
  display.print(F("/100 "));


 //DHTSensor
  display.setCursor(0, 40);
  display.print(F("Humidity: "));
  display.print(hum);
  display.print(F("%"));
  display.setCursor(0, 30);
  display.print(F("Ambient Temp:"));
  display.print(temp,1);
  display.print(F(" C"));

//Time & Date
  display.setCursor(0, 0);
  display.print(now.year());
  display.print("-");
  if (now.month() < 10) display.print("0");
  display.print(now.month());
  display.print("-");
  if (now.day() < 10) display.print("0");
  display.print(now.day());

  display.print(" ");

  if (now.hour() < 10) display.print("0");
  display.print(now.hour());
  display.print(":");
  if (now.minute() < 10) display.print("0");
  display.print(now.minute());
  display.print(":");
  if (now.second() < 10) display.print("0");
  display.println(now.second());

  //ModeAuto
    display.setCursor(0, 50);
    display.print(F("NutrientMode:"));
    if (ModeAuto == true){
      display.print(F("Auto"));
    }
    if (ModeAuto == false){
      display.print(F("Manual"));
    }
    display.display();  

  }
  
if (drainRunning == false){
 //Read buttonStates
  K1State = digitalRead(K1Pin);
  K2State = digitalRead(K2Pin);
  K3State = digitalRead(K3Pin);
  K4State = digitalRead(K4Pin);
  unsigned long nowMs = millis();

  if (lastK1State == HIGH && K1State == LOW) {
      handlePress(K1Pin, nowMs);
      ModeAuto = !ModeAuto; 
  }
  if (lastK2State == HIGH && K2State == LOW) {  //Refresh
    handlePress(K2Pin, nowMs);
  }
	if (lastK3State == HIGH && K3State == LOW) { //Drain
      handlePress(K3Pin, nowMs);
      display.clearDisplay();
      display.setTextSize(1);
			display.setCursor(0, 10);
			display.print(F("ENTER THE PIN..."));
      display.display();
      delay(800); 
  }
if (lastK4State == HIGH && K4State == LOW) {
  handlePress(K4Pin, nowMs);
  aboutStartMillis = nowMs;         // start timer
  aboutShowing = true;
  aboutDisplayed = false;         // we'll draw it once
  }
  // non-blocking About screen handling
  if (aboutShowing) {
    if (!aboutDisplayed) {
      // draw About screen once
      display.clearDisplay();
      display.setCursor(0, 0);
      display.setTextSize(1);
      display.print(F("Made By:"));
      display.setCursor(0, 5);
      display.print(F("-------"));
      display.setCursor(0, 10);
      display.print(F("Ganesh Kishore, First-Year Biotech at UWR."));
      display.setCursor(0, 25);
      display.print(F("---------------------"));
      display.setCursor(0, 30);
      display.println(F("I dream to raise questionable amounts of money for even more questionable startups."));
      display.setCursor(0, 60);
      display.print(F("---------------------"));
      display.display();
      aboutDisplayed = true;
    }
  // if duration expired -> stop showing about screen
  if (nowMs - aboutStartMillis >= ABOUT_DURATION_MS) {
    aboutShowing = false;
    aboutDisplayed = false;
    lastSignificantActivity = nowMs; 
  }
}

  lastK1State = K1State;
  lastK2State = K2State;
  lastK3State = K3State;
  lastK4State = K4State;
 if (seqIndex != 0 && (nowMs - seqStartMillis > SEQ_TIMEOUT_MS)) {
    seqIndex = 0;
    }

//IdleTimeout
   //LEDloop //Start for 
  if (LEDState) {
    // LED is currently ON — check if ON time elapsed -> turn OFF
    if (nowMs - LEDStartTime >= LEDCycleOnDuration) {
      digitalWrite(LEDPIN, LOW);
      LEDState = false;
      LEDStartTime = nowMs;   // mark time of change (nowMs OFF)
     }
  } else {
  // LED is currently OFF — check if OFF time elapsed -> turn ON
  if (nowMs - LEDStartTime >= LEDCycleOffDuration) {
    digitalWrite(LEDPIN, HIGH);
    LEDState = true;
    LEDStartTime = nowMs;   // mark time of change (nowMs ON)
  }
  }
  if (K1State == LOW || K2State == LOW || K3State == LOW || K4State == LOW) {
    lastSignificantActivity = nowMs;
    if (idleMode) {
      idleMode = false;      // immediate wake
      idleGifFrameIndex = 0;
     }
   } 

  if (!idleMode && (nowMs - lastSignificantActivity >= IDLE_TO_GIF_MS)) {
    idleMode = true;
    idleStartTime = nowMs;
    idleGifFrameIndex = 0;
    lastGifFrameTime = nowMs;
  }
  if (idleMode && (nowMs - idleStartTime >= IDLE_SCREEN_DURATION)) {
    idleMode = false;
    idleGifFrameIndex = 0;
    lastSignificantActivity = nowMs;   // prevent immediate re-entry
    }
  if (idleMode) {
    if (nowMs - lastGifFrameTime >= IDLE_GIF_FRAME_MS) {
      lastGifFrameTime = nowMs;
      const unsigned char *bmp = CatGifallArray[idleGifFrameIndex];
      display.clearDisplay();
      display.drawBitmap(0, 0, bmp, SCREEN_WIDTH, SCREEN_HEIGHT, SSD1306_WHITE);
      display.display();

      idleGifFrameIndex++;
      if (idleGifFrameIndex >= CatGifallArray_LEN) idleGifFrameIndex = 0;
    } 
    return;
  }
}
}
void handlePress(uint8_t pinPressed, unsigned long nowMs) {
  // debounce
  if (nowMs - lastSignificantActivity < DEBOUNCE_MS) return;
  lastSignificantActivity = nowMs;

  // starting sequence?
  if (seqIndex == 0) {
    if (pinPressed == requiredSequence[0]) {
      seqIndex = 1;
      seqStartMillis = nowMs;    // <-- IMPORTANT: start the timeout timer
    }
    return;
  }

  // mid-sequence: correct step?
  if (pinPressed == requiredSequence[seqIndex]) {
    seqIndex++;
    Serial.println(F("Correct key"));
    seqStartMillis = nowMs;      // <-- IMPORTANT: refresh timeout
    if (seqIndex >= SEQ_LEN) {
      seqIndex = 0;
      Serial.println(F("=========="));
      Serial.println(F(" DRAIN RUNNING "));
      Serial.println(F("=========="));
      drainRunning = true;
    }
  } else {
    seqIndex = 0; 
    Serial.println(F("wrong key"));            // wrong button -> reset
  }
}